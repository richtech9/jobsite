<?php/** current-php-code 2020-Oct-12* input-sanitized : action,lang,sortBy,* current-wp-template:  customer viewing all proposals*/global $wpdb;global $post;$lang = FLInput::get('lang', 'en');$sort_by = FLInput::get('sortBy');$action = FLInput::get('action');$post_id = get_the_ID();$current_user = wp_get_current_user();$current_user_id = $current_user->ID;$SiteLang = $lang;$prizesAwarded = get_post_meta($post_id, 'contest_awardedProposalPrizes', true);$prizesProposalAwarded = get_post_meta($post_id, 'contest_awardedProposalPrizes', true);$proposalPresent = explode(',', $prizesProposalAwarded);$author_id = $post->post_author;$job_type = get_post_meta($post_id, 'fl_job_type', true);$addParticipants = get_post_meta($post_id, 'all_contest_paricipants', true);$curParti = explode(',', $addParticipants);?><style>    .slide-inn figure {        height: auto !important;    }    .slider .eye img, .eye img {        display: inline-block !important;        height: auto !important;        width: auto !important;        vertical-align: middle;        background: transparent !important;        margin: 0 auto;    }    .slide-inn .eye {        left: 0;        position: absolute;        text-align: center;        top: 40%;        width: 100%;        z-index: 10;        display: none;    }</style><div class="customer-participants">    <div class="title-top">        <div class="container"><i class="icon icon-box"></i>            <p class="large-text">                <?php echo get_post_meta($post_id, 'project_title', true); ?>            </p>        </div>    </div>    <section class="middle-content job_dtls">        <div class="container">            <div class="days-left">                 <?php				//code-notes removed echoing the contest id                if ($prizesAwarded != '') {                    ?>                    <span class="bold-and-blocking large-text ">Winners</span>                    <div class="comment-row">                    <?php                    $lingPresent = explode(',', $prizesAwarded);                    $p1 = 1;                    $auth_or = $post->post_author;                    ////////////////////////////////////////////////////////////////////////                    $order_by = '';                    if ($sort_by === 'rating') {                        $order_by = 'order by wp.rating desc';                        $proposals = $wpdb->get_results("SELECT * FROM wp_proposals wp WHERE wp.post_id = $post_id AND wp.by_user != $auth_or $order_by");                    } else if ($sort_by === 'time') {                        $order_by = 'order by wp.id desc';                        $proposals = $wpdb->get_results("SELECT * FROM wp_proposals wp WHERE wp.post_id = $post_id AND wp.by_user != $auth_or $order_by");                    } else if ($sort_by === 'freelancer') {                        $order_by = 'order by wu.display_name desc';                        $proposals = $wpdb->get_results("SELECT * FROM wp_proposals wp left join wp_users wu on wp.by_user  = wu.ID WHERE wp.post_id = $post_id AND wp.by_user != $auth_or $order_by");                    } else {                        $order_by = 'order by wp.id desc';                        $proposals = $wpdb->get_results("SELECT * FROM wp_proposals wp WHERE wp.post_id = $post_id AND wp.by_user != $auth_or $order_by");                    }                    /// ////////////////////////////////////////////////////////////////////////                    foreach ($proposals as $key => $value) {                        if (empty(intval($value->by_user))) { continue;}                        if (in_array($value->id, $lingPresent)) {                            ?>                            <div class="col-md-2">                                <div class="winner-main-full-width" style="margin-bottom: 0.5em">                                    <div class="winner-inner-full-width">                                        <figure class="column large_figure">                                            <a href="<?php echo freeling_links('user_account') ?>&profile_type=translator&user=<?php echo get_userdata($value->by_user)->user_login ?>&b_url=<?php echo $post_id ?>">                                                <?php                                                    //code-notes [image-sizing]  using hz_get_profile_thumb for sized image                                                    $avatar = hz_get_profile_thumb($value->by_user,FreelinguistSizeImages::TINY,true);                                                ?>                                                    <img style="" src="<?= $avatar ?>">                                            </a>                                        </figure>							        <div class="enhanced-text p-holder">                                        <div style="display: inline-block">                                            #<?= $p1 ?>                                            <?= FLRedDot::generate_dot_html_for_user(                                                [ FLRedDot::TYPE_PROPOSAL],$value->id                                            );                                            ?>                                        </div>                                        <p>                                            <a href="<?= freeling_links('user_account') . '&profile_type=translator&user=' . get_userdata($value->by_user)->user_login .                                                             '&b_url=' . $post_id?>"                                            >                                                <?= substr(get_da_name($value->by_user), 0, 10) ?>                                            </a>                                        </p>							        </div>                                </div> <!--- ./winner-inner-full-width -->                                    <a class="shp-btn btn blue-btn regular-text"                                       href="<?=get_site_url().'/job/'.get_the_title($post_id).'/?lang='.                                       $SiteLang.'&action=winner-proposal&linguist='.$value->by_user.'&proposalId='.$value->id?>"                                    >                                        Work Delivery                                    </a>                            </div> <!--- ./winner-main-full-width -->                        </div><!--- ./col -->                        <?php                        } //end if in-array                        $p1++;                    } //end for each proposals                    echo '</div>';                }                //code-notes putting in words about when the contest deadline and award period ends. on the customer page                FreelinguistContestCancellation::make_words_about_contest_deadlines($post_id,$log,$deadline_string,$award_string);                //will_dump('log',$log);                ?>                <span class="time-remaining">                    <span class="days-before-contest-deadline">                        <?= $deadline_string ?>                    </span>                    <span class="days-before-award-deadline">                        <?= $award_string ?>                    </span>                </span> <!-- /.time-remaining -->            </div> <!-- /.days-left -->            <div class="row submissions_btns">                <?php                $auth_or = $post->post_author;                $order_by = '';                if ($sort_by === 'rating') {                    $order_by = 'order by wp.rating desc';                    $proposals = $wpdb->get_results("SELECT * FROM wp_proposals wp WHERE wp.post_id = $post_id AND wp.by_user != $auth_or $order_by");                } else if ($sort_by === 'time') {                    $order_by = 'order by wp.id desc';                    $proposals = $wpdb->get_results("SELECT * FROM wp_proposals wp WHERE wp.post_id = $post_id AND wp.by_user != $auth_or $order_by");                } else if ($sort_by === 'freelancer') {                    $order_by = 'order by wu.display_name desc';                    $proposals = $wpdb->get_results("SELECT * FROM wp_proposals wp left join wp_users wu on wp.by_user  = wu.ID WHERE wp.post_id = $post_id AND wp.by_user != $auth_or $order_by");                } else {                    $order_by = 'order by wp.id desc';                    $proposals = $wpdb->get_results("SELECT * FROM wp_proposals wp WHERE wp.post_id = $post_id AND wp.by_user != $auth_or $order_by");                }                ?>                <div class="labels enhanced-text">                    <?php                    if (count($proposals) != 0) {                        echo count($proposals) . ' proposals';                    } else {                        echo 'no proposal.';                    }                    ?>                    <form method="GET" action="" id="sortForm" style="margin-top: 15px;">                        <input type="hidden" name="lang" value="<?= $lang ?>">                        <input type="hidden" name="action" value="<?=$action ?>">                        <select title="Sort By" name="sortBy" id="sortBy" style="padding: 4px 4px; height: 33px;">                            <option value="">Select sort type</option>                            <option value="rating" <?=$sort_by === 'rating' ? 'selected' : ''; ?>>                                Rating                            </option>                            <option value="time" <?= $sort_by === 'time' ? 'selected' : ''; ?>>                                Time                            </option>                            <option value="freelancer" <?= $sort_by === 'freelancer' ? 'selected' : ''; ?>>                                Freelancer                            </option>                        </select>                    </form>                </div> <!-- /.labels enhanced-text -->                <a class="hirebttn2 fr"                   href="<?php echo get_site_url(); ?>/job/<?php echo get_the_title($post_id); ?>/?lang=<?php echo $SiteLang; ?>"                >                    Job Details                </a>            </div> <!-- /.row-->        </div> <!-- /.days-left-->        <div class="column-sec">            <div class="container">                <div class="row">                    <div id="table_pag" class="table table-striped">                        <?php                        if (count($proposals) > 0) {                            $p = 1;                            foreach ($proposals as $key => $value) {                                if (empty(intval($value->by_user))) { continue;}                                $uploads = wp_upload_dir();                                $LingUser = get_user_by('id', $value->by_user);                                $fileUrl = '';                                $mySubmissions = $wpdb->get_results("SELECT * FROM wp_files WHERE `post_id` = $post_id AND by_user = $value->by_user AND proposal_id=$value->id order by id desc limit 1");                                foreach ($mySubmissions as $uploaded) {                                    $fileUrl = $uploads['baseurl'] . '/' . $uploaded->file_path;                                    break;                                }                                $extension = pathinfo($fileUrl, PATHINFO_EXTENSION);                                $ling_link = freeling_links('user_account') . '&profile_type=translator&user=' . $LingUser->user_login . '&b_url=' . $post_id;                                ?>                                <div class="data col-md-3 col-md-3 col-xs-2">                                    <div class="box">                                        <div class="num-row comment-row">                                            <div class="winner-main-full-width">                                                <div class="winner-inner-full-width">                                                    <a href="<?php echo $ling_link; ?>" target="_blank">                                                        <?php                                                            //code-notes [image-sizing]  using hz_get_profile_thumb for sized image                                                            $avatar = hz_get_profile_thumb($value->by_user,FreelinguistSizeImages::TINY,true);                                                        ?>                                                        <figure class="column"><img style="" src="<?= $avatar ?>"></figure>                                                    </a>                                                    <div class="enhanced-text p-holder">                                                        <div style="display: inline-block">                                                            <?php echo '#' . $p; ?>                                                            <?= FLRedDot::generate_dot_html_for_user(                                                                [ FLRedDot::TYPE_PROPOSAL],$value->id                                                            );                                                            ?>                                                        </div>                                                        <p>                                                            <?= substr(get_da_name($value->by_user),0,10)?>                                                        </p>                                                    </div> <!-- /.p-holder -->                                                    <?php                                                    //code-notes chat part                                                    set_query_var( 'job_id', $value->post_id );                                                    set_query_var( 'to_user_id', $value->by_user );                                                    set_query_var( 'proposal_id', $value->id );                                                    set_query_var( 'job_type', 'competition' );                                                    set_query_var( 'b_show_name', 0 );                                                    get_template_part('includes/user/chat/chat','button-area');                                                    ?>                                                </div> <!-- winner-inner-full-width -->                                            </div> <!-- winner-main-full-width -->                                        </div> <!-- /.comment-row -->                                        <div class="fig-img slide-inn">                                            <a href="<?php echo get_site_url() . '/job/' . get_the_title($post_id) . '/?lang=' .                                                        $SiteLang . '&action=proposal&linguist=' . $value->by_user . '&proposalId=' . $value->id; ?>"                                            >                                                <figure>                                                    <?php                                                    if ($extension == 'pdf') {                                                        ?>                                                        <embed src="<?= $fileUrl ?>" width="100%" height="600" type="application/pdf">                                                        <?php                                                    } elseif ($extension == 'txt') {                                                        ?>                                                        <embed src="<?= $fileUrl ?>" width="100%" height="600" type="text/plain">                                                        <?php                                                    } elseif ($extension == 'php') {                                                        ?>                                                        <embed src="<?= $fileUrl ?>" width="100%" height="600" type="text/plain">                                                        <?php                                                    } elseif ($extension == 'mp3') {                                                        ?>                                                        <audio controls><source src="<?= $fileUrl ?>" type="audio/mpeg"></audio>                                                        <?php                                                    } elseif ($extension == 'doc' || $extension == 'docx') {                                                        ?>                                                        <object data="<?= $fileUrl ?>" type="application/*"></object>                                                        <?php                                                    } elseif ($extension == 'mp4' || $extension == 'mov' || $extension == '3gp' || $extension == 'wmv') {                                                        ?>                                                        <video width="400" controls>												            <source src="<?= $fileUrl ?>" type="video/mp4">												                Your browser does not support HTML5 video.												        </video>                                                        <?php                                                    } else {                                                        ?>                                                        <img src="<?= $fileUrl ?>" alt="Cannot open <?= $extension ?>" style="width:100%;">                                                        <?php                                                    }                                                    ?>                                                </figure>                                                <span class="eye">											        <img src="<?php echo get_template_directory_uri().'/images/eye-see.png' ?>"                                                         alt="freelinguist"/>										        </span>                                            </a>                                        </div> <!-- /.fig-img slide-inn -->                                        <?php $job_freeze = false;                                        if (in_array($value->by_user, get_post_meta($post_id, 'job_freeze_user')) && !empty(get_post_meta($post_id, 'job_freeze_user'))) {                                            $job_freeze = true;                                        }                                        if (!$job_freeze) {                                            ?>                                            <div class="rating-img">                                                <?php                                                if ($current_user_id == $author_id && !$job_freeze) {                                                    ?>                                                    <div class="row fl-proposal-buttons">                                                        <div class="col-sm-12 col-md-6  no-padding-no-margin">                                                            <!--  code-notes moved the stars to here but had to wrap them in a new div to work-->                                                            <div class="customer-rating-for-proposal-stars-holder">                                                            <div class="ratingss inline-here" id="proposal-<?php echo $value->id; ?>">                                                                <input type="hidden" name="rating" id="rating"                                                                       value="<?php echo $value->rating; ?>"/>                                                                <ul onMouseOut="resetRating(<?php echo $value->id; ?>);">                                                                    <?php                                                                    for ($i = 1; $i <= 5; $i++) {                                                                        $selected = "";                                                                        if (!empty($value->rating) && $i <= $value->rating) {                                                                            $selected = "selected";                                                                        }                                                                        ?>                                                                        <li class='<?php echo $selected; ?> large-text'                                                                            onmouseover="highlightStar(this,<?php echo $value->id; ?>);"                                                                            onmouseout="removeHighlight(<?php echo $value->id; ?>);"                                                                            onClick="addRating(this,<?php echo $value->id; ?>);">â˜…                                                                        </li>                                                                    <?php } ?>                                                                </ul>                                                            </div> <!-- /.ratingss -->                                                            </div>                                                        </div> <!-- /.col -->                                                        <div class="col-sm-12 col-md-6 no-padding-no-margin">                                                    <?php                                                    if (!in_array($value->id, $proposalPresent)) {                                                        ?>                                                                <a href="#"                                                                   class= "awardProposalPrize red-btn btn button-normal2  fl-proposal-button fl-proposal-button-right regular-text"                                                                   linguist="<?= $value->by_user ?>"                                                                   proposal_id = "<?= $value->id ?>"                                                                   data-toggle="modal"                                                                   data-target="#awardPops"                                                                   style=""                                                                >                                                                    Award Proposal                                                                </a>                                                        <?php                                                    } else {                                                        ?>                                                            <a  href="#"                                                                class="green-text a-button fl-proposal-button fl-proposal-button-right regular-text"                                                                style=""                                                            >                                                                Prize Awarded                                                            </a>                                                        <?php                                                    }//end if else proposal won                                                   ?>                                                        </div> <!-- /.col -->                                                    </div><!-- /.fl-proposal-buttons  -->                                                    <?php                                                }//end if the proposal author is this user and the job is not forzen                                                ?>                                                <!-- code-notes where the stars used to be -->                                            </div> <!-- /.rating-img-->                                        <?php } //end if not job freeze ?>                                    </div> <!-- /.box-->                                </div> <!--- /.data.col -->                                <?php                                $p++;                            } //end foreach proposal                        } else {                            ?>                            <div class="no-columns">                                <p>Our freelancers are working on the competition! Please come back later to review their submissions!</p>                            </div>                            <?php                        }                        ?>                    </div><!-- /.table-->                </div>   <!--- /.row -->            </div> <!--- /.container -->        </div> <!--- /.column-sec -->        <!-- popup -->        <div id="awardPops" class="modal" role="dialog">            <div class="modal-dialog">                <!-- Modal content-->                <div class="modal-content">                    <div class="modal-header">                        <button type="button" class="close huge-text" data-dismiss="modal">&times;</button>                        <h4 class="modal-title">Award prize to this proposal. You can still request revisions. </h4>                    </div>                    <div class="modal-body hirepopup">                        <div class="row">                            <div class="col-md-12">                                <button linguId="" class="bttns btn blue-btn regular-text" contestId="<?php echo $post_id; ?>"                                        id="yes_proposal_btn">Yes                                </button>                                <span class="awardResponse"></span>                            </div>                        </div>                    </div>                </div> <!-- /.modal-content -->            </div> <!-- /.modal-dialog -->        </div> <!-- /.modal#awardPops-->    </section> <!-- /.container--></div> <!-- /.customer-participants --><script type="text/javascript">jQuery(function ($) {    jQuery('#sortBy').change(function () {        $('#sortForm').submit();    });});</script>